version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: orcamento-app:latest
    container_name: orcamento-app
    restart: unless-stopped
    ports:
      - "8000:80"
    environment:
      APP_NAME: "Orçamento App"
      APP_ENV: production
      APP_DEBUG: false
      APP_URL: http://localhost:8000

      APP_LOCALE: pt_BR
      APP_FALLBACK_LOCALE: pt_BR
      APP_FAKER_LOCALE: pt_BR

      LOG_CHANNEL: stack
      LOG_LEVEL: info

      # SQLite (padrão)
      DB_CONNECTION: sqlite
      DB_DATABASE: /var/www/html/database/database.sqlite

      # Configurações de sessão, cache e queue
      SESSION_DRIVER: database
      CACHE_STORE: database
      QUEUE_CONNECTION: database

      # Controles do entrypoint
      RUN_MIGRATIONS: "true"
      RUN_SEEDERS: "false"
      # volumes:
      # Persistir banco de dados SQLite (comentado - causa problemas de permissão no Windows)
      # - ./database/database.sqlite:/var/www/html/database/database.sqlite
      # Persistir logs (comentado - causa problemas de permissão no Windows)
      # - ./storage/logs:/var/www/html/storage/logs
      # Persistir arquivos de upload (comentado - causa problemas de permissão no Windows)
      # - ./storage/app:/var/www/html/storage/app
    networks:
      - orcamento-network
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  # Database PostgreSQL (opcional - descomente se preferir usar PostgreSQL)
  # db:
  #   image: postgres:16-alpine
  #   container_name: orcamento-db
  #   restart: unless-stopped
  #   environment:
  #     POSTGRES_DB: orcamento_familiar
  #     POSTGRES_USER: orcamento_user
  #     POSTGRES_PASSWORD: senha_segura_aqui
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   networks:
  #     - orcamento-network
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U orcamento_user -d orcamento_familiar"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

networks:
  orcamento-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
